name: SecurePy Enterprise Audit

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  security-check:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Check out the repository code (Updated to v4)
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Set up Python environment (Updated to v5)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Install Dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install rich

      # 4. Run SecurePy Scanner
      # We pipe the output to a log file so we can upload it later
      - name: Run Security Scanner
        run: |
          echo "ðŸš€ Starting Enterprise Security Audit..."
          # The 'tee' command prints to screen AND saves to file at the same time
          python main.py test_vulnerable.py 2>&1 | tee output.log
          
          # We check the exit code of python manually to ensure the build fails if issues are found
          # (tee always returns 0, so we use PIPESTATUS to get the python exit code)
          exit ${PIPESTATUS[0]}

      # 5. Upload Report if failed (Updated to v4)
      - name: Upload Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: output.log